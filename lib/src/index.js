"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const chalk_1 = __importDefault(require("chalk"));
const figlet_1 = __importDefault(require("figlet"));
const commander_1 = __importDefault(require("commander"));
const drainer_1 = require("./drainer");
const filler_1 = require("./filler");
const package_json_1 = __importDefault(require("../package.json"));
const i18n_1 = __importDefault(require("i18n"));
i18n_1.default.configure({
    directory: __dirname + '/locales',
    objectNotation: true,
});
const QUEUE_1 = 'queue_1';
const QUEUE_2 = 'queue_2';
const QUEUE_3 = 'queue_3';
const BANNER_QDRAINER = 'Q Drainer';
const BANNER_QFILLER = 'Q Filler';
const fonts = figlet_1.default.fontsSync();
const font = fonts[Math.floor(Math.random() * fonts.length)];
commander_1.default
    .version(package_json_1.default.version)
    .option('-m --mode <mode>', 'mode to drain or fill', 'drain')
    .option('-h, --host <host>', 'rabbit host', 'localhost')
    .option('-p, --port <port>', 'rabbit port', '5672')
    .option('-v, --vhost <vhost>', 'virtual host', '')
    .option('-u, --user <user>', 'rabbit user')
    .option('-c, --password <password>', 'rabbit password')
    .option('-q, --queue <queue>', `queue name e.g. ${QUEUE_1}, ${QUEUE_2} or ${QUEUE_3}`, 'test_q')
    .option('-l, --log-message', 'log the dequeued message.  This will be ignored if used with --log-message-csv')
    .option('--log-message-csv', 'log the dequeued message as CSV')
    .option('-n, --num-to-consume [num>', 'The number of messages to consume and if absent consume all')
    .parse(process.argv);
const host = commander_1.default.host;
const port = commander_1.default.port;
const user = commander_1.default.user;
const password = commander_1.default.password;
const vhost = commander_1.default.vhost;
const queue = commander_1.default.queue;
const logMessage = commander_1.default.logMessage;
const logMessageCsv = commander_1.default.logMessageCsv;
const numToConsume = commander_1.default.numToConsume || 0;
const mode = process.env.MODE || commander_1.default.mode;
const isFillerMode = mode === 'fill';
if (isFillerMode) {
    console.log(chalk_1.default.green(figlet_1.default.textSync(BANNER_QFILLER, { font, horizontalLayout: 'full' })));
}
else {
    console.log(chalk_1.default.yellow(figlet_1.default.textSync(BANNER_QDRAINER, { font, horizontalLayout: 'full' })));
}
if (!(host && port && queue)) {
    console.error(i18n_1.default.__('err_missingArgs'));
    console.error(commander_1.default.help());
    process.exit(1);
}
let url;
if (user && password) {
    url = `amqp://${user}:${password}@${host}:${port}`.concat(vhost ? `/${vhost}` : '');
}
else {
    url = `amqp://${host}:${port}`.concat(vhost ? `/${vhost}` : '');
}
if (isFillerMode) {
    const filler = new filler_1.Filler(url, queue, logMessage, logMessageCsv, i18n_1.default);
    if (numToConsume === 0) {
        filler.publishMessage().catch(() => console.info('oh oh'));
    }
}
else {
    const drainer = new drainer_1.Drainer(url, queue, logMessage, logMessageCsv, i18n_1.default);
    if (numToConsume === 0) {
        drainer.consumeMessages().catch(() => console.info('oh oh'));
    }
    else {
        drainer.consumeNmessages(numToConsume).catch(() => console.info('oh oh'));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxrREFBMEI7QUFDMUIsb0RBQTRCO0FBQzVCLDBEQUFnQztBQUNoQyx1Q0FBb0M7QUFDcEMscUNBQWtDO0FBQ2xDLG1FQUFrQztBQUNsQyxnREFBd0I7QUFDeEIsY0FBSSxDQUFDLFNBQVMsQ0FBQztJQUNiLFNBQVMsRUFBRSxTQUFTLEdBQUcsVUFBVTtJQUNqQyxjQUFjLEVBQUUsSUFBSTtDQUNyQixDQUFDLENBQUM7QUFHSCxNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUM7QUFDMUIsTUFBTSxPQUFPLEdBQUcsU0FBUyxDQUFDO0FBQzFCLE1BQU0sT0FBTyxHQUFHLFNBQVMsQ0FBQztBQUUxQixNQUFNLGVBQWUsR0FBRyxXQUFXLENBQUM7QUFDcEMsTUFBTSxjQUFjLEdBQUcsVUFBVSxDQUFDO0FBRWxDLE1BQU0sS0FBSyxHQUFHLGdCQUFNLENBQUMsU0FBUyxFQUFFLENBQUM7QUFDakMsTUFBTSxJQUFJLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0FBRTdELG1CQUFPO0tBQ0osT0FBTyxDQUFDLHNCQUFHLENBQUMsT0FBTyxDQUFDO0tBQ3BCLE1BQU0sQ0FBQyxrQkFBa0IsRUFBRSx1QkFBdUIsRUFBRSxPQUFPLENBQUM7S0FDNUQsTUFBTSxDQUFDLG1CQUFtQixFQUFFLGFBQWEsRUFBRSxXQUFXLENBQUM7S0FDdkQsTUFBTSxDQUFDLG1CQUFtQixFQUFFLGFBQWEsRUFBRSxNQUFNLENBQUM7S0FDbEQsTUFBTSxDQUFDLHFCQUFxQixFQUFFLGNBQWMsRUFBRSxFQUFFLENBQUM7S0FDakQsTUFBTSxDQUFDLG1CQUFtQixFQUFFLGFBQWEsQ0FBQztLQUMxQyxNQUFNLENBQUMsMkJBQTJC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SyxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztLQUM1RDtDQUNGO0tBQU07SUFDTCxNQUFNLE9BQU8sR0FBWSxJQUFJLGlCQUFPLENBQ2xDLEdBQUcsRUFDSCxLQUFLLEVBQ0wsVUFBVSxFQUNWLGFBQWEsRUFDYixjQUFJLENBQ0wsQ0FBQztJQUNGLElBQUksWUFBWSxLQUFLLENBQUMsRUFBRTtRQUN0QixPQUFPLENBQUMsZUFBZSxFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztLQUM5RDtTQUFNO1FBQ0wsT0FBTyxDQUFDLGdCQUFnQixDQUFDLFlBQVksQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7S0FDM0U7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjaGFsayBmcm9tICdjaGFsayc7XG5pbXBvcnQgZmlnbGV0IGZyb20gJ2ZpZ2xldCc7XG5pbXBvcnQgcHJvZ3JhbSBmcm9tICdjb21tYW5kZXInO1xuaW1wb3J0IHsgRHJhaW5lciB9IGZyb20gJy4vZHJhaW5lcic7XG5pbXBvcnQgeyBGaWxsZXIgfSBmcm9tICcuL2ZpbGxlcic7XG5pbXBvcnQgcGtnIGZyb20gJy4uL3BhY2thZ2UuanNvbic7XG5pbXBvcnQgaTE4biBmcm9tICdpMThuJztcbmkxOG4uY29uZmlndXJlKHtcbiAgZGlyZWN0b3J5OiBfX2Rpcm5hbWUgKyAnL2xvY2FsZXMnLFxuICBvYmplY3ROb3RhdGlvbjogdHJ1ZSxcbn0pO1xuXG4vLyBleGFtcGxlIHF1ZXVlIG5hbWVzXG5jb25zdCBRVUVVRV8xID0gJ3F1ZXVlXzEnO1xuY29uc3QgUVVFVUVfMiA9ICdxdWV1ZV8yJztcbmNvbnN0IFFVRVVFXzMgPSAncXVldWVfMyc7XG5cbmNvbnN0IEJBTk5FUl9RRFJBSU5FUiA9ICdRIERyYWluZXInO1xuY29uc3QgQkFOTkVSX1FGSUxMRVIgPSAnUSBGaWxsZXInO1xuXG5jb25zdCBmb250cyA9IGZpZ2xldC5mb250c1N5bmMoKTtcbmNvbnN0IGZvbnQgPSBmb250c1tNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiBmb250cy5sZW5ndGgpXTtcblxucHJvZ3JhbVxuICAudmVyc2lvbihwa2cudmVyc2lvbilcbiAgLm9wdGlvbignLW0gLS1tb2RlIDxtb2RlPicsICdtb2RlIHRvIGRyYWluIG9yIGZpbGwnLCAnZHJhaW4nKVxuICAub3B0aW9uKCctaCwgLS1ob3N0IDxob3N0PicsICdyYWJiaXQgaG9zdCcsICdsb2NhbGhvc3QnKVxuICAub3B0aW9uKCctcCwgLS1wb3J0IDxwb3J0PicsICdyYWJiaXQgcG9ydCcsICc1NjcyJylcbiAgLm9wdGlvbignLXYsIC0tdmhvc3QgPHZob3N0PicsICd2aXJ0dWFsIGhvc3QnLCAnJylcbiAgLm9wdGlvbignLXUsIC0tdXNlciA8dXNlcj4nLCAncmFiYml0IHVzZXInKVxuICAub3B0aW9uKCctYywgLS1wYXNzd29yZCA8cGFzc3dvcmQ+JywgJ3JhYmJpdCBwYXNzd29yZCcpXG4gIC5vcHRpb24oXG4gICAgJy1xLCAtLXF1ZXVlIDxxdWV1ZT4nLFxuICAgIGBxdWV1ZSBuYW1lIGUuZy4gJHtRVUVVRV8xfSwgJHtRVUVVRV8yfSBvciAke1FVRVVFXzN9YCxcbiAgICAndGVzdF9xJ1xuICApXG4gIC5vcHRpb24oXG4gICAgJy1sLCAtLWxvZy1tZXNzYWdlJyxcbiAgICAnbG9nIHRoZSBkZXF1ZXVlZCBtZXNzYWdlLiAgVGhpcyB3aWxsIGJlIGlnbm9yZWQgaWYgdXNlZCB3aXRoIC0tbG9nLW1lc3NhZ2UtY3N2J1xuICApXG4gIC5vcHRpb24oJy0tbG9nLW1lc3NhZ2UtY3N2JywgJ2xvZyB0aGUgZGVxdWV1ZWQgbWVzc2FnZSBhcyBDU1YnKVxuICAub3B0aW9uKFxuICAgICctbiwgLS1udW0tdG8tY29uc3VtZSBbbnVtPicsXG4gICAgJ1RoZSBudW1iZXIgb2YgbWVzc2FnZXMgdG8gY29uc3VtZSBhbmQgaWYgYWJzZW50IGNvbnN1bWUgYWxsJ1xuICApXG4gIC5wYXJzZShwcm9jZXNzLmFyZ3YpO1xuXG5jb25zdCBob3N0OiBzdHJpbmcgPSBwcm9ncmFtLmhvc3Q7XG5jb25zdCBwb3J0OiBzdHJpbmcgPSBwcm9ncmFtLnBvcnQ7XG5jb25zdCB1c2VyOiBzdHJpbmcgPSBwcm9ncmFtLnVzZXI7XG5jb25zdCBwYXNzd29yZDogc3RyaW5nID0gcHJvZ3JhbS5wYXNzd29yZDtcbmNvbnN0IHZob3N0OiBzdHJpbmcgPSBwcm9ncmFtLnZob3N0O1xuY29uc3QgcXVldWU6IHN0cmluZyA9IHByb2dyYW0ucXVldWU7XG5jb25zdCBsb2dNZXNzYWdlOiBib29sZWFuID0gcHJvZ3JhbS5sb2dNZXNzYWdlO1xuY29uc3QgbG9nTWVzc2FnZUNzdjogYm9vbGVhbiA9IHByb2dyYW0ubG9nTWVzc2FnZUNzdjtcbmNvbnN0IG51bVRvQ29uc3VtZTogbnVtYmVyID0gcHJvZ3JhbS5udW1Ub0NvbnN1bWUgfHwgMDtcbmNvbnN0IG1vZGU6IHN0cmluZyA9IHByb2Nlc3MuZW52Lk1PREUgfHwgcHJvZ3JhbS5tb2RlO1xuY29uc3QgaXNGaWxsZXJNb2RlID0gbW9kZSA9PT0gJ2ZpbGwnO1xuXG5pZiAoaXNGaWxsZXJNb2RlKSB7XG4gIGNvbnNvbGUubG9nKFxuICAgIGNoYWxrLmdyZWVuKFxuICAgICAgZmlnbGV0LnRleHRTeW5jKEJBTk5FUl9RRklMTEVSLCB7IGZvbnQsIGhvcml6b250YWxMYXlvdXQ6ICdmdWxsJyB9KVxuICAgIClcbiAgKTtcbn0gZWxzZSB7XG4gIGNvbnNvbGUubG9nKFxuICAgIGNoYWxrLnllbGxvdyhcbiAgICAgIGZpZ2xldC50ZXh0U3luYyhCQU5ORVJfUURSQUlORVIsIHsgZm9udCwgaG9yaXpvbnRhbExheW91dDogJ2Z1bGwnIH0pXG4gICAgKVxuICApO1xufVxuXG5pZiAoIShob3N0ICYmIHBvcnQgJiYgcXVldWUpKSB7XG4gIGNvbnNvbGUuZXJyb3IoaTE4bi5fXygnZXJyX21pc3NpbmdBcmdzJykpO1xuICBjb25zb2xlLmVycm9yKHByb2dyYW0uaGVscCgpKTtcbiAgcHJvY2Vzcy5leGl0KDEpO1xufVxuXG5sZXQgdXJsO1xuXG5pZiAodXNlciAmJiBwYXNzd29yZCkge1xuICB1cmwgPSBgYW1xcDovLyR7dXNlcn06JHtwYXNzd29yZH1AJHtob3N0fToke3BvcnR9YC5jb25jYXQoXG4gICAgdmhvc3QgPyBgLyR7dmhvc3R9YCA6ICcnXG4gICk7XG59IGVsc2Uge1xuICB1cmwgPSBgYW1xcDovLyR7aG9zdH06JHtwb3J0fWAuY29uY2F0KHZob3N0ID8gYC8ke3Zob3N0fWAgOiAnJyk7XG59XG5cbmlmIChpc0ZpbGxlck1vZGUpIHtcbiAgY29uc3QgZmlsbGVyOiBGaWxsZXIgPSBuZXcgRmlsbGVyKFxuICAgIHVybCxcbiAgICBxdWV1ZSxcbiAgICBsb2dNZXNzYWdlLFxuICAgIGxvZ01lc3NhZ2VDc3YsXG4gICAgaTE4blxuICApO1xuICBpZiAobnVtVG9Db25zdW1lID09PSAwKSB7XG4gICAgZmlsbGVyLnB1Ymxpc2hNZXNzYWdlKCkuY2F0Y2goKCkgPT4gY29uc29sZS5pbmZvKCdvaCBvaCcpKTtcbiAgfVxufSBlbHNlIHtcbiAgY29uc3QgZHJhaW5lcjogRHJhaW5lciA9IG5ldyBEcmFpbmVyKFxuICAgIHVybCxcbiAgICBxdWV1ZSxcbiAgICBsb2dNZXNzYWdlLFxuICAgIGxvZ01lc3NhZ2VDc3YsXG4gICAgaTE4blxuICApO1xuICBpZiAobnVtVG9Db25zdW1lID09PSAwKSB7XG4gICAgZHJhaW5lci5jb25zdW1lTWVzc2FnZXMoKS5jYXRjaCgoKSA9PiBjb25zb2xlLmluZm8oJ29oIG9oJykpO1xuICB9IGVsc2Uge1xuICAgIGRyYWluZXIuY29uc3VtZU5tZXNzYWdlcyhudW1Ub0NvbnN1bWUpLmNhdGNoKCgpID0+IGNvbnNvbGUuaW5mbygnb2ggb2gnKSk7XG4gIH1cbn1cbiJdfQ==